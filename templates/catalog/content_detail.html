{% extends 'base.html' %}
{% load static %}

{% block head_title %}{{ content.title }}{% endblock %}

{% block content %}

  {% with bg_url=content.backdrop_url|default:content.poster_url %}
    {% if bg_url %}
      <div class="page-bg" style="--bg: url('{{ bg_url }}');"></div>
    {% else %}
      <div class="page-bg page-bg--empty"></div>
    {% endif %}
  {% endwith %}

<div id="content-root" data-content-id="{{ content.id }}">
  <section class="content-detail">
    <div class="info">
      <h1 class="title">{{ content.title }}</h1>

      <div class="meta-row">
        {% if content.year %}<span class="year">{{ content.year }}</span>{% endif %}
        <span class="avg" id="avgRating">{{ content.rating|default:"-" }}</span>
      </div>

      {% if content.description %}
        <p class="desc">{{ content.description }}</p>
      {% endif %}

      {% if genres %}
        <div class="desc" class="genres-inline">Жанры: {{ genres|join:", " }}</div>
      {% endif %}

      <!-- Кнопки действий -->
      <div class="controls-row" id="controlsRow" style="margin-top:16px; display:flex; gap:10px;">
        <button id="openMainBtn" type="button" class="btn btn-primary btn-lg" style="display:none;">Смотреть</button>
        {% if not content.can_watch and content.cta_url %}
          <a id="ctaBtn" class="btn btn-primary" href="{{ content.cta_url }}">{{ content.cta_label }}</a>
        {% endif %}
        {% if user.is_authenticated %}
          <button id="favBtn"
                  class="btn btn-fav"
                  data-post-url="{% url 'catalog:favorite_toggle' content.id %}"
                  data-check-url="{% url 'catalog:favorite_status' content.id %}">
            <span class="star" aria-hidden="true">☆</span>
            <span class="label">Добавить в избранное</span>
          </button>
        {% else %}
          <a class="btn btn-outline" href="{% url 'login' %}?next={{ request.path|urlencode }}">
            ☆ Войти, чтобы добавить в избранное
          </a>
        {% endif %}
      </div>

      <!-- === МОДАЛЬНОЕ ОКНО ДЛЯ ТРЕЙЛЕРА === -->
      <div id="trailerModal" class="modal">
        <div class="modal__inner">
          <div class="modal__header">
            <div class="modal__title" id="trailerTitle">Трейлер</div>
            <button class="modal__close" type="button" onclick="closeTrailer()">×</button>
          </div>
          <div class="modal__video">
            <iframe id="trailerFrame" src="" allowfullscreen></iframe>
          </div>
        </div>
      </div>


      {% if it.genres %}<span class="hero-genres">{{ it.genres|join:", " }}</span>{% endif %}

      <!-- Панель сезонов/серий: рендерится JS; для сериалов показывается, для фильмов скрыто -->
      <div id="seriesPanel" class="card" style="margin-top:12px; display:none;">
        <div class="card__header" style="display:flex;align-items:center;justify-content:space-between;">
          <div class="card__title">Сезоны</div>
          <button id="seriesBackBtn" class="btn" type="button" style="display:none;">Вернуться к сезонам</button>
        </div>
        <div class="card__body" id="seriesPanelBody"></div>
      </div>
    </div>

    <div class="art">
      {% if content.poster_url %}
        <img id="coverImg" src="{{ content.poster_url }}" alt="{{ content.title }}">
      {% endif %}
    </div>
  </section>

  <!-- Контейнер, куда JS при необходимости смонтирует iframe плеера -->
  <section class="player-block">
    <div class="player" id="playerContainer">
      <iframe id="playerFrame" src="" frameborder="0" allowfullscreen style="display:none; width:100%; aspect-ratio:16/9;"></iframe>
    </div>
  </section>
</div>

<link rel="stylesheet" href="{% static 'css/content_detail.css' %}">
<script src="{% static 'js/content_detail.js' %}"></script>
{% endblock %}