{% extends 'base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ - {{ plan.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/purchase_confirm.css' %}">
{% endblock %}

{% if current_subscription %}
<input type="hidden" name="extend_after_current" value="true">
{% else %}
<input type="hidden" name="extend_after_current" value="false">
{% endif %}

{% block content %}
  <div class="container">
    <div class="purchase-header">
      <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h1>
      <p class="muted">–û–ø–ª–∞—Ç–∞ –∑–∞—â–∏—â–µ–Ω–∞. –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ.</p>
    </div>

    {% if messages %}
      <div class="messages">
        {% for m in messages %}
          <div class="alert {% if m.tags %}alert-{{ m.tags }}{% endif %}">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="purchase-content">
      <div class="content-info">
        <div class="content-card">
          <div class="subscription-icon" style="text-align: center; padding: 20px;">
            <span style="font-size: 80px;">üì∫</span>
          </div>
          
          <div class="content-details">
            <h2>{{ plan.name }}</h2>
            <div class="content-meta">
              <span class="content-type">–ü–æ–¥–ø–∏—Å–∫–∞</span>
              <span class="content-year">{{ plan.period_months }} –º–µ—Å—è—Ü–µ–≤</span>
            </div>
            
            <div class="subscription-period">
                <h4>–ü–µ—Ä–∏–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏:</h4>
                
                {% if current_subscription %}
                    <div class="alert alert-info" style="background: linear-gradient(135deg, #e8f4ff 0%, #d4e7ff 100%); border-left: 4px solid #00a8ff; padding: 15px; margin: 15px 0; border-radius: 8px;">
                        <p><strong>‚ö†Ô∏è –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</strong></p>
                        <p>–¢–µ–∫—É—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞: <strong>{{ current_subscription.plan.name }}</strong></p>
                        <p>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: <strong>{{ current_subscription.expires_at|date:"d.m.Y" }}</strong></p>
                        <p>–ù–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞—á–Ω–µ—Ç—Å—è: <strong>{{ new_subscription_start|date:"d.m.Y" }}</strong></p>
                    </div>
                {% else %}
                    <p>–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞—á–Ω–µ—Ç—Å—è: <strong>{{ new_subscription_start|date:"d.m.Y" }}</strong></p>
                    <p>–ü–æ–¥–ø–∏—Å–∫–∞ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è: <strong>{{ new_subscription_expiry|date:"d.m.Y" }}</strong></p>
                {% endif %}
            </div>
            
            <div class="content-description">
              <h4>–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:</h4>
              <ul style="list-style: none; padding-left: 0;">
                <li>‚úì –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ (0.01-0.99 ‚ÇΩ)</li>
                <li>‚úì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω</li>
                <li>‚úì –ü–ª–∞—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–æ—Ç 1 ‚ÇΩ) –ø–æ–∫—É–ø–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ</li>
                <li>‚úì –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞</li>
                <li>‚úì –û—Ç–º–µ–Ω–∞ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π</li>
              </ul>
            </div>
            
            <div class="content-price">
              <div class="price-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏:</div>
              <div class="price-amount">{{ plan.price|floatformat:0 }} ‚ÇΩ</div>
            </div>
          </div>
        </div>
        
        <div class="purchase-benefits">
          <h4>–£—Å–ª–æ–≤–∏—è –æ—Ç–º–µ–Ω—ã:</h4>
          <ul style="list-style: none; padding-left: 0;">
            <li>‚ùó –û—Ç–º–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π —Å –Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—Å–∫–∏</li>
            <li>‚ùó –ü–æ—Å–ª–µ 14 –¥–Ω–µ–π –æ—Ç–º–µ–Ω–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞</li>
            <li>‚ùó –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ</li>
          </ul>
        </div>
      </div>

      <div class="payment-form">
        <div class="payment-card">
          <h3>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
          
          <form method="post" action="{% url 'catalog:process_subscription_payment' plan.code %}" id="payment-form">
            {% csrf_token %}
            
            {% if current_subscription %}
            <input type="hidden" name="extend_after_current" id="extendHidden" value="true">
            {% endif %}
            
            <div class="form-section">
              <label for="card_number">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
              <div class="input-with-icon">
                <input
                    type="text"
                    id="card_number"
                    inputmode="numeric"
                    autocomplete="cc-number"
                    maxlength="19"
                    name="card_number"
                    placeholder="4242 4242 4242 4242"
                    class="form-input">
                <span class="input-icon">üí≥</span>
                <span class="card-type-indicator">
                  <span class="visa-icon" style="display: none;">VISA</span>
                  <span class="mastercard-icon" style="display: none;">MC</span>
                  <span class="mir-icon" style="display: none;">–ú–ò–†</span>
                </span>
              </div>
              <div class="card-icons">
                <span class="card-icon">visa</span>
                <span class="card-icon">mastercard</span>
                <span class="card-icon">mir</span>
              </div>
              <div id="card-error" class="error-message" style="display: none;"></div>
            </div>

            <div class="form-row">
              <div class="form-section">
                <label for="expiry_date">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                <div class="input-with-icon">
                    <input type="text" 
                      type="text"
                      id="expiry_date"
                      name="expiry_date"
                      inputmode="numeric"
                      autocomplete="cc-exp"
                      maxlength="5"
                      placeholder="MM/YY"
                      class="form-input"
                      required>
                </div>
              </div>
              
              <div class="form-section">
                <label for="cvc">CVC/CVV</label>
                <div class="input-with-icon">
                  <input type="password" 
                    id="cvc" 
                    name="cvc" 
                    placeholder="123"
                    maxlength="3"
                    inputmode="numeric"
                    pattern="[0-9]{3}"
                    required
                    autocomplete="cc-csc">
                  <span class="input-icon">üîí</span>
                </div>
              </div>
            </div>

            <div class="form-section">
              <label for="cardholder_name">–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞—Ä—Ç—ã</label>
              <div class="input-with-icon">
                <input type="text" 
                     id="cardholder_name"
                     autocomplete="cc-name"
                     name="cardholder_name"
                     placeholder="IVAN IVANOV"
                     required>
              </div>
            </div>

            <div class="form-section">
              <label for="email">Email –¥–ª—è —á–µ–∫–∞</label>
              <div class="input-with-icon">
                <input type="email" 
                     id="email" 
                     name="email" 
                     value="{{ user.email|default:'' }}"
                     placeholder="your@email.com"
                     required>
              </div>
            </div>

            <div class="payment-summary">
              <div class="summary-row">
                <span>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ ({{ plan.period_months }} –º–µ—Å.):</span>
                <span>{{ plan.price|floatformat:0 }} ‚ÇΩ</span>
              </div>
              <div class="summary-row">
                <span>–ö–æ–º–∏—Å—Å–∏—è:</span>
                <span>0 ‚ÇΩ</span>
              </div>
              <div class="summary-row total">
                <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                <span class="total-amount">{{ plan.price|floatformat:0 }} ‚ÇΩ</span>
              </div>
            </div>

            <div class="payment-actions">
              <button type="submit" class="btn btn-primary btn-lg btn-pay">
                <span class="btn-icon">üí≥</span>
                –û–ø–ª–∞—Ç–∏—Ç—å {{ plan.price|floatformat:0 }} ‚ÇΩ
              </button>
              
              <a href="{% url 'catalog:subscribe' %}" class="btn btn-outline btn-lg">
                –û—Ç–º–µ–Ω–∞
              </a>
            </div>

            <div class="payment-security">
              <p>‚úÖ –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</p>
              <p>‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π</p>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% block extra_js %}
    <script src="{% static 'js/payment_validation.js' %}"></script>
    <script src="{% static 'js/subscription_logic.js' %}"></script>
  {% endblock %}
{% endblock %}