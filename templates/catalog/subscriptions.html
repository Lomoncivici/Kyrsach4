{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/purchase.css' %}">
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="purchase-page">
  <div class="container mt-4">

    {% if messages %}
      <div class="messages">
        {% for m in messages %}
          <div class="alert {% if m.tags %}alert-{{ m.tags }}{% endif %}">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="panel subscription-panel">
      <h2>–í–∞—à–∞ —Ç–µ–∫—É—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</h2>
      {% if subscription and subscription.is_actually_active %}
        <div class="subscription-status active">
          <p><strong>–ê–∫—Ç–∏–≤–Ω–∞: {{ subscription.plan.name }}</strong></p>
          <p>–¶–µ–Ω–∞: {{ subscription.plan.price }} ‚ÇΩ</p>

          {% if subscription.expires_at %}
            <p>
              –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ:
              <time datetime="{{ subscription.expires_at|date:'c' }}">
                {{ subscription.expires_at|date:'d.m.Y H:i' }}
              </time>
            </p>
          {% endif %}

          <p>–ü–µ—Ä–∏–æ–¥: {{ subscription.plan.period_months }} –º–µ—Å.</p>
          <p>–°—Ç–∞—Ç—É—Å: {{ subscription.status|title }}</p>
        </div>
      {% else %}
        <p class="muted">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏</p>
      {% endif %}
    </div>

    <div class="panel">
      <h2 class="h2">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–ø–∏—Å–æ–∫</h2>

      {% if subscriptions %}
        <ul class="sub-history">
          {% for sub in subscriptions %}
            <li class="sub-item
              {% if sub.is_actually_active %}is-active
              {% elif sub.status == 'cancelled' %}is-cancelled
              {% elif sub.get_actual_status == 'expired' %}is-expired
              {% endif %}">

              <div class="sub-main">
                <div class="sub-title">
                  {{ sub.plan.name }}
                  <span class="sub-period">{{ sub.plan.period_months }} –º–µ—Å.</span>

                  {% if sub.is_actually_active and sub.expires_at %}
                    <span class="sub-days-left">
                      (–æ—Å—Ç–∞–ª–æ—Å—å {{ sub.expires_at|timeuntil }})
                    </span>
                  {% endif %}
                </div>

                <div class="sub-status">
                  {% if sub.is_actually_active %}
                    <span class="status-badge status-active">–ê–∫—Ç–∏–≤–Ω–∞</span>
                    {% if sub.expires_at %}
                      <div class="sub-expires">
                        –¥–æ {{ sub.expires_at|date:"d.m.Y" }}
                      </div>
                    {% endif %}
                  {% elif sub.status == 'cancelled' %}
                    <span class="status-badge status-cancelled">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
                  {% elif sub.get_actual_status == 'expired' %}
                    <span class="status-badge status-expired">–ò—Å—Ç–µ–∫–ª–∞</span>
                  {% else %}
                    <span class="status-badge status-other">
                      {{ sub.get_actual_status }}
                    </span>
                  {% endif %}
                </div>
              </div>

              <div class="sub-meta">
                <span>{{ sub.started_at|date:"d.m.Y" }}</span>
                <span>‚Äî</span>
                <span>
                  {% if sub.expires_at %}
                    {{ sub.expires_at|date:"d.m.Y" }}
                  {% else %}
                    ‚àû
                  {% endif %}
                </span>

                <span class="sub-price">
                  {{ sub.plan.price|floatformat:0 }} ‚ÇΩ
                </span>
              </div>

              {% if sub.is_actually_active %}
                <div class="sub-actions">
                  <form method="post"
                        action="{% url 'catalog:cancel_subscription' %}">
                    {% csrf_token %}
                    <input type="hidden" name="subscription_id" value="{{ sub.id }}">
                    <button class="btn btn-outline btn-sm btn-danger-soft"
                            onclick="confirmCancelSubscription('{{ sub.plan.name }}', {{ sub.days_since_start }})">
                      –û—Ç–º–µ–Ω–∏—Ç—å
                    </button>
                  </form>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>

        <div class="sub-summary muted">
          –í—Å–µ–≥–æ: {{ subscriptions|length }},
          –∞–∫—Ç–∏–≤–Ω—ã—Ö: {{ active_count }},
          –æ—Ç–º–µ–Ω–µ–Ω–æ: {{ cancelled_count }},
          –∏—Å—Ç–µ–∫–ª–æ: {{ expired_count }}
        </div>
      {% else %}
        <p class="muted">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –ø—É—Å—Ç–∞</p>
      {% endif %}
    </div>

    <div class="panel">
      <h2 class="h2">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫</h2>
      
      {% if plans %}
        <div class="subscription-plans">
          {% for plan in plans %}
            <div class="subscription-plan-card {% if subscription and subscription.plan.id == plan.id %}current-plan{% endif %}">
              <div class="plan-header">
                <h3 class="plan-name">{{ plan.name }}</h3>
                {% if subscription and subscription.plan.id == plan.id %}
                  <span class="current-badge">–¢–µ–∫—É—â–∞—è</span>
                {% endif %}
              </div>
              
              <div class="plan-price">
                <span class="price-amount">{{ plan.price|floatformat:0 }}</span>
                <span class="price-currency">‚ÇΩ</span>
                <span class="price-period">/ {{ plan.period_months }} –º–µ—Å.</span>
              </div>
              
              <div class="plan-features">
                <ul>
                  <li>–î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</li>
                  <li>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω</li>
                  <li>–ü–ª–∞—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–∫—É–ø–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ</li>
                  {% if plan.period_months == 12 %}
                    <li class="feature-highlight">üéÅ –°–∞–º–∞—è –≤—ã–≥–æ–¥–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –≥–æ–¥</li>
                  {% endif %}
                </ul>
              </div>
              
              <div class="plan-actions">
                {% if subscription and subscription.plan.id == plan.id %}
                  <button class="btn btn-outline btn-sm w-100" disabled>
                    –¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω
                  </button>
                {% else %}
                  <a href="{% url 'catalog:activate_subscription' plan.code %}" 
                    class="btn btn-primary btn-sm w-100">
                    {% if has_active_subscription %}
                      –°–º–µ–Ω–∏—Ç—å –ø–ª–∞–Ω
                    {% else %}
                      –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                    {% endif %}
                  </a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
        
        <div class="plan-info muted">
          <p>üí° –ü–ª–∞—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–∫—É–ø–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–µ –∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ !</p>
        </div>
      {% else %}
        <p class="muted">–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏</p>
      {% endif %}
    </div>

    <div class="panel my-section purchase-page">
      <h2 class="h2">–ö—É–ø–∏—Ç—å —Ñ–∏–ª—å–º</h2>

      <form method="get"
            action="{% url 'catalog:subscribe' %}"
            class="purchase-search">
        <input type="text"
              name="q"
              placeholder="–ü–æ–∏—Å–∫ —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤‚Ä¶"
              value="{{ query }}">
        <button class="btn btn-outline btn-sm">–ù–∞–π—Ç–∏</button>
      </form>

      {% if content_list %}
        <div class="cards-container">
          <div class="cards-grid">
            {% for content in content_list %}
              <div class="card purchase-card">

                {% if content.cover_image %}
                  <img src="{{ content.cover_image.url }}"
                      alt="{{ content.title }}">
                {% endif %}

                <div class="card-title">{{ content.title }}</div>
                <div class="card-meta">
                  {{ content.description|truncatewords:12 }}
                </div>
                <div class="card-meta">
                  <strong>{{ content.price|floatformat:0 }} ‚ÇΩ</strong>
                </div>

                <div class="card-actions">
                  <a href="{% url 'catalog:content_detail' pk=content.id %}"
                    class="btn btn-outline btn-sm w-100">
                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                  </a>
                  <a href="{% url 'catalog:purchase_start' pk=content.id %}"
                    class="btn btn-primary btn-sm w-100">
                    –ö—É–ø–∏—Ç—å
                  </a>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <p class="muted">
          {% if query %}
            –ü–æ –∑–∞–ø—Ä–æ—Å—É ¬´{{ query }}¬ª –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
          {% else %}
            –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏
          {% endif %}
        </p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/subscription_logic.js' %}"></script>
{% endblock %}