{% extends 'employees/admin/admin_base.html' %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ - –ü–æ–¥–ø–∏—Å–∫–∏{% endblock %}
{% block page_title %}üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏{% endblock %}

{% block admin_nav %}
{{ block.super }}
<a href="{% url 'admin_subscriptions' %}" 
   {% if request.resolver_match.url_name == 'admin_subscriptions' %}class="active"{% endif %}>
   üí∞ –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã
</a>
<a href="{% url 'admin_payments' %}" 
   {% if request.resolver_match.url_name == 'admin_payments' %}class="active"{% endif %}>
   üí≥ –ü–ª–∞—Ç–µ–∂–∏
</a>
{% endblock %}

{% block content %}
<div class="content-box">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">–ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
        <div>
            <a href="{% url 'admin_grant_subscription' %}" class="btn btn-success">üéÅ –í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</a>
            <a href="{% url 'export_subscriptions' %}?type=user_subs" class="btn" style="background: #4a5568;">üìä –≠–∫—Å–ø–æ—Ä—Ç</a>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 14px; color: #718096;">–í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫</div>
            <div style="font-size: 24px; font-weight: bold;">{{ stats.0|default:0 }}</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 14px; color: #718096;">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            <div style="font-size: 24px; font-weight: bold; color: #48bb78;">{{ stats.1|default:0 }}</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 14px; color: #718096;">–ò—Å—Ç–µ–∫—à–∏—Ö</div>
            <div style="font-size: 24px; font-weight: bold; color: #e53e3e;">{{ stats.2|default:0 }}</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 14px; color: #718096;">–ë—É–¥—É—â–∏—Ö</div>
            <div style="font-size: 24px; font-weight: bold; color: #ed8936;">{{ stats.4|default:0 }}</div>
        </div>
    </div>
    
    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <form method="get" id="filterForm" style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
            <input type="text" name="search" value="{{ search_query }}" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∏–Ω—É –∏–ª–∏ email..." 
                   style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px;">
            <button type="submit" class="btn" style="background: #4299e1;">üîç –ü–æ–∏—Å–∫</button>
            <button type="button" onclick="clearFilters()" class="btn" style="background: #a0aec0;">‚ùå –û—á–∏—Å—Ç–∏—Ç—å</button>
        </form>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <div>
                <select name="status" id="statusFilter" onchange="submitForm()" style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 4px;">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="expired" {% if status_filter == 'expired' %}selected{% endif %}>–ò—Å—Ç–µ–∫—à–∏–µ</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ</option>
                    <option value="future" {% if status_filter == 'future' %}selected{% endif %}>–ë—É–¥—É—â–∏–µ</option>
                </select>
            </div>
            
            <div>
                <select name="plan" id="planFilter" onchange="submitForm()" style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 4px;">
                    <option value="all" {% if plan_filter == 'all' %}selected{% endif %}>–í—Å–µ —Ç–∞—Ä–∏—Ñ—ã</option>
                    {% for plan in active_plans %}
                    <option value="{{ plan.0 }}" {% if plan_filter == plan.0 %}selected{% endif %}>{{ plan.1 }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <input type="date" name="date_from" id="dateFrom" value="{{ date_from }}" 
                       placeholder="–î–∞—Ç–∞ —Å" style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 4px;"
                       onchange="submitForm()">
            </div>
            <div>
                <input type="date" name="date_to" id="dateTo" value="{{ date_to }}" 
                       placeholder="–î–∞—Ç–∞ –ø–æ" style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 4px;"
                       onchange="submitForm()">
            </div>
        </div>
    </div>
    
    {% if subscriptions %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–¢–∞—Ä–∏—Ñ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ù–∞—á–∞–ª–æ</th>
                    <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                    <th>–û–ø–ª–∞—Ç–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for sub in subscriptions %}
                <tr>
                    <td>
                        <strong>{{ sub.user_login }}</strong>
                        <div style="font-size: 12px; color: #718096;">
                            {{ sub.user_email|truncatechars:20 }}
                        </div>
                        <div style="font-size: 11px; font-family: monospace; color: #a0aec0;">
                            ID: {{ sub.user_id|slice:":8" }}...
                        </div>
                    </td>
                    <td>
                        {{ sub.plan_name }}
                        <div style="font-size: 12px; color: #718096;">
                            {{ sub.plan_code }}
                        </div>
                    </td>
                    <td>
                        {% if sub.actual_status == 'active' %}
                        <span class="badge" style="background: #48bb78;">–ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% elif sub.actual_status == 'expired' %}
                        <span class="badge" style="background: #e53e3e;">–ò—Å—Ç–µ–∫–ª–∞</span>
                        {% elif sub.actual_status == 'cancelled' %}
                        <span class="badge" style="background: #a0aec0;">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
                        {% elif sub.actual_status == 'future' %}
                        <span class="badge" style="background: #ed8936;">–ë—É–¥—É—â–∞—è</span>
                        {% else %}
                        <span class="badge" style="background: #a0aec0;">{{ sub.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ sub.started_at|date:"d.m.Y" }}
                    </td>
                    <td>
                        {% if sub.expires_at %}
                        {{ sub.expires_at|date:"d.m.Y" }}
                        {% if sub.actual_status == 'active' %}
                        <div style="font-size: 12px; color: #718096;">
                            {{ sub.expires_at|timeuntil }} –æ—Å—Ç–∞–ª–æ—Å—å
                        </div>
                        {% endif %}
                        {% else %}
                        <span style="color: #a0aec0;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if sub.payment_amount %}
                        <strong>{{ sub.payment_amount }} ‚ÇΩ</strong>
                        {% if sub.paid_at %}
                        <div style="font-size: 12px; color: #718096;">
                            {{ sub.paid_at|date:"d.m.Y" }}
                        </div>
                        {% endif %}
                        {% else %}
                        <span style="color: #a0aec0;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td class="actions">
                        <a href="{% url 'admin_user_subscription_edit' sub.id %}" class="btn" style="padding: 4px 8px; font-size: 12px;">‚úèÔ∏è</a>
                        
                        <form method="post" action="{% url 'admin_user_subscription_extend' sub.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn" style="background: #4299e1; padding: 4px 8px; font-size: 12px;"
                                    onclick="return confirm('–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ 1 –º–µ—Å—è—Ü?')">
                                ‚è≥ +1 –º–µ—Å
                            </button>
                        </form>
                        
                        <form method="post" action="{% url 'admin_user_subscription_delete' sub.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger" 
                                    style="padding: 4px 8px; font-size: 12px;"
                                    onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ sub.user_login }}?')">
                                üóëÔ∏è
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if search_query or status_filter != 'all' or plan_filter != 'all' or date_from or date_to %}
    <div style="margin-top: 20px; padding: 10px; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 4px;">
        –ù–∞–π–¥–µ–Ω–æ {{ subscriptions|length }} –ø–æ–¥–ø–∏—Å–æ–∫
        {% if search_query %}–ø–æ –∑–∞–ø—Ä–æ—Å—É: "<strong>{{ search_query }}</strong>"{% endif %}
        {% if status_filter != 'all' %}—Å—Ç–∞—Ç—É—Å: <strong>{{ status_filter }}</strong>{% endif %}
        {% if plan_filter != 'all' %}—Ç–∞—Ä–∏—Ñ: <strong>{{ plan_filter }}</strong>{% endif %}
        {% if date_from %}—Å {{ date_from }}{% endif %}
        {% if date_to %}–ø–æ {{ date_to }}{% endif %}
    </div>
    {% endif %}
    
    {% else %}
    <div style="text-align: center; padding: 40px; color: #718096;">
        {% if search_query or status_filter != 'all' or plan_filter != 'all' or date_from or date_to %}
        <p>–ü–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
        <a href="{% url 'admin_user_subscriptions' %}" class="btn" style="margin-top: 15px;">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏</a>
        {% else %}
        <p>–ü–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        <a href="{% url 'admin_grant_subscription' %}" class="btn btn-success" style="margin-top: 15px;">–í—ã–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    document.getElementById('statusFilter').value = urlParams.get('status') || 'all';
    document.getElementById('planFilter').value = urlParams.get('plan') || 'all';
    document.getElementById('dateFrom').value = urlParams.get('date_from') || '';
    document.getElementById('dateTo').value = urlParams.get('date_to') || '';
    
    const searchInput = document.querySelector('input[name="search"]');
    searchInput.value = urlParams.get('search') || '';
});

function submitForm() {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    
    const searchValue = document.querySelector('input[name="search"]').value;
    const statusValue = document.getElementById('statusFilter').value;
    const planValue = document.getElementById('planFilter').value;
    const dateFromValue = document.getElementById('dateFrom').value;
    const dateToValue = document.getElementById('dateTo').value;
    

    const params = new URLSearchParams();
    
    if (searchValue) params.set('search', searchValue);
    if (statusValue && statusValue !== 'all') params.set('status', statusValue);
    if (planValue && planValue !== 'all') params.set('plan', planValue);
    if (dateFromValue) params.set('date_from', dateFromValue);
    if (dateToValue) params.set('date_to', dateToValue);
    
    window.location.href = '{% url "admin_user_subscriptions" %}' + (params.toString() ? '?' + params.toString() : '');
}

function clearFilters() {
    window.location.href = '{% url "admin_user_subscriptions" %}';
}
</script>
{% endblock %}