{% extends 'employees/admin/admin_base.html' %}

{% block title %}–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã - –ü–æ–¥–ø–∏—Å–∫–∏ –∏ –ø–ª–∞—Ç–µ–∂–∏{% endblock %}
{% block page_title %}üí∞ –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã{% endblock %}

{% block admin_nav %}
{{ block.super }}
<a href="{% url 'admin_user_subscriptions' %}" 
   {% if request.resolver_match.url_name == 'admin_user_subscriptions' %}class="active"{% endif %}>
   üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
</a>
<a href="{% url 'admin_payments' %}" 
   {% if request.resolver_match.url_name == 'admin_payments' %}class="active"{% endif %}>
   üí≥ –ü–ª–∞—Ç–µ–∂–∏
</a>
{% endblock %}

{% block content %}
<div class="content-box">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫</h2>
        <div>
            <a href="{% url 'admin_subscription_create' %}" class="btn btn-success">‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–∞—Ä–∏—Ñ</a>
            <a href="{% url 'export_subscriptions' %}?type=plans" class="btn" style="background: #4a5568;">üìä –≠–∫—Å–ø–æ—Ä—Ç</a>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 14px; color: #718096;">–í—Å–µ–≥–æ —Ç–∞—Ä–∏—Ñ–æ–≤</div>
            <div style="font-size: 24px; font-weight: bold;">{{ total_plans }}</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 14px; color: #718096;">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            <div style="font-size: 24px; font-weight: bold; color: #48bb78;">{{ active_plans }}</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 14px; color: #718096;">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è</div>
            <div style="font-size: 24px; font-weight: bold;">{{ used_plans|default:0 }}</div>
        </div>
    </div>
    
    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <form method="get" style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
            <input type="text" name="search" value="{{ search_query }}" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∫–æ–¥—É..." 
                   style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px;">
            <button type="submit" class="btn" style="background: #4299e1;">üîç –ü–æ–∏—Å–∫</button>
            {% if search_query or status_filter != 'all' %}
            <a href="{% url 'admin_subscriptions' %}" class="btn" style="background: #a0aec0;">‚ùå –û—á–∏—Å—Ç–∏—Ç—å</a>
            {% endif %}
        </form>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="?search={{ search_query }}&status=all" 
               class="btn {% if status_filter == 'all' %}active{% endif %}" 
               style="background: #4a5568;">–í—Å–µ</a>
            <a href="?search={{ search_query }}&status=active" 
               class="btn {% if status_filter == 'active' %}active{% endif %}" 
               style="background: #48bb78;">–ê–∫—Ç–∏–≤–Ω—ã–µ</a>
            <a href="?search={{ search_query }}&status=inactive" 
               class="btn {% if status_filter == 'inactive' %}active{% endif %}" 
               style="background: #a0aec0;">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</a>
        </div>
    </div>
    
    {% if plans %}
    <table>
        <thead>
            <tr>
                <th>–ö–æ–¥</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ü–µ—Ä–∏–æ–¥</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°–æ–∑–¥–∞–Ω</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for plan in plans %}
            <tr>
                <td><strong>{{ plan.code }}</strong></td>
                <td>
                    <strong>{{ plan.name }}</strong>
                    <div style="font-size: 12px; color: #718096;">
                        ID: {{ plan.id|slice:":8" }}...
                    </div>
                </td>
                <td>{{ plan.period_months }} –º–µ—Å.</td>
                <td>
                    <strong>{{ plan.price }} ‚ÇΩ</strong>
                    {% if plan.period_months > 1 %}
                    <div style="font-size: 12px; color: #718096;">
                        {% widthratio plan.price plan.period_months 1 as price_per_month %}
                        ~{{ price_per_month|floatformat:2 }} ‚ÇΩ/–º–µ—Å
                    </div>
                    {% endif %}
                </td>
                <td>
                    {{ plan.user_count }}
                    {% if plan.active_count > 0 %}
                    <div style="font-size: 12px; color: #48bb78;">
                        {{ plan.active_count }} –∞–∫—Ç–∏–≤.
                    </div>
                    {% endif %}
                </td>
                <td>
                    {% if plan.is_active %}
                    <span class="badge" style="background: #48bb78;">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% else %}
                    <span class="badge" style="background: #a0aec0;">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                    {% endif %}
                </td>
                <td>{{ plan.created_at|date:"d.m.Y" }}</td>
                <td class="actions">
                    <a href="{% url 'admin_subscription_edit' plan.id %}" class="btn" style="padding: 4px 8px; font-size: 12px;">‚úèÔ∏è</a>
                    
                    {% if plan.is_active %}
                    <form method="post" action="{% url 'admin_subscription_toggle' plan.id %}" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="deactivate">
                        <button type="submit" class="btn" style="background: #ed8936; padding: 4px 8px; font-size: 12px;"
                                onclick="return confirm('–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–∞—Ä–∏—Ñ ¬´{{ plan.name }}¬ª?')">
                            ‚è∏Ô∏è
                        </button>
                    </form>
                    {% else %}
                    <form method="post" action="{% url 'admin_subscription_toggle' plan.id %}" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="activate">
                        <button type="submit" class="btn" style="background: #48bb78; padding: 4px 8px; font-size: 12px;">
                            ‚ñ∂Ô∏è
                        </button>
                    </form>
                    {% endif %}
                    
                    <form method="post" action="{% url 'admin_subscription_delete' plan.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" 
                                style="padding: 4px 8px; font-size: 12px;"
                                onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ ¬´{{ plan.name }}¬ª?')">
                            üóëÔ∏è
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if search_query %}
    <div style="margin-top: 20px; padding: 10px; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 4px;">
        –ù–∞–π–¥–µ–Ω–æ {{ plans|length }} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "<strong>{{ search_query }}</strong>"
    </div>
    {% endif %}
    
    {% else %}
    <div style="text-align: center; padding: 40px; color: #718096;">
        {% if search_query %}
        <p>–ü–æ –∑–∞–ø—Ä–æ—Å—É "{{ search_query }}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
        <a href="{% url 'admin_subscriptions' %}" class="btn" style="margin-top: 15px;">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</a>
        {% else %}
        <p>–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        <a href="{% url 'admin_subscription_create' %}" class="btn btn-success" style="margin-top: 15px;">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ç–∞—Ä–∏—Ñ</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}