{% extends 'employees/admin/admin_base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}
{% block page_title %}üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏{% endblock %}

{% block admin_nav %}
{{ block.super }}
<a href="{% url 'admin_users_list' %}" 
   {% if request.resolver_match.url_name == 'admin_users_list' %}class="active"{% endif %}>
   üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
</a>
<a href="{% url 'admin_employees_list' %}" 
   {% if request.resolver_match.url_name == 'admin_employees_list' %}class="active"{% endif %}>
   üë®‚Äçüíº –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
</a>
{% endblock %}

{% block content %}
<div class="content-box">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
        <a href="{% url 'admin_user_create' %}" class="btn btn-success">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
            <div style="font-size: 14px; color: #718096;">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            <div style="font-size: 24px; font-weight: bold;">{{ stats.0 }}</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
            <div style="font-size: 14px; color: #718096;">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            <div style="font-size: 24px; font-weight: bold; color: #48bb78;">{{ stats.1 }}</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
            <div style="font-size: 14px; color: #718096;">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</div>
            <div style="font-size: 24px; font-weight: bold; color: #e53e3e;">{{ stats.2 }}</div>
        </div>
    </div>

    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <form method="get" id="filterForm" style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
            <input type="text" name="search" value="{{ search_query }}" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ email, –ª–æ–≥–∏–Ω—É..." 
                   style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px;">
            <button type="submit" class="btn" style="background: #4299e1;">üîç –ü–æ–∏—Å–∫</button>
            <button type="button" onclick="clearFilters()" class="btn" style="background: #a0aec0;">‚ùå –û—á–∏—Å—Ç–∏—Ç—å</button>
        </form>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <div>
                <select name="status" id="statusFilter" onchange="submitForm()" style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 4px;">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                </select>
            </div>

            <div>
                <input type="date" name="date_from" id="dateFrom" value="{{ date_from }}" 
                       placeholder="–î–∞—Ç–∞ —Å" style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 4px;"
                       onchange="submitForm()">
            </div>
            <div>
                <input type="date" name="date_to" id="dateTo" value="{{ date_to }}" 
                       placeholder="–î–∞—Ç–∞ –ø–æ" style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 4px;"
                       onchange="submitForm()">
            </div>
        </div>
    </div>
    
    {% if users %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–õ–æ–≥–∏–Ω / Email</th>
                    <th>–†–æ–ª–∏</th>
                    <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    <th>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>
                        <span style="font-size: 11px; font-family: monospace; color: #718096;">
                            {{ user.id|slice:":8" }}...
                        </span>
                    </td>
                    <td>
                        <div style="font-weight: bold;">{{ user.login }}</div>
                        <div style="font-size: 12px; color: #718096;">{{ user.email }}</div>
                        {% if user.avatar_url %}
                        <div style="font-size: 11px; margin-top: 3px;">
                            <a href="{{ user.avatar_url }}" target="_blank" style="color: #4299e1;">üñºÔ∏è –ê–≤–∞—Ç–∞—Ä</a>
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.roles %}
                        <div style="font-size: 12px;">
                            {% for role in user.roles.split|default:"" %}
                                {% if role and role|length > 0 %}
                                    <span class="badge" style="background: #805ad5; margin: 1px 2px; display: inline-block;">
                                        {{ role|striptags }}
                                    </span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <span style="color: #a0aec0; font-size: 12px;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_active %}
                        <span class="badge" style="background: #48bb78;">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% else %}
                        <span class="badge" style="background: #e53e3e;">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="font-size: 12px;">
                            <div>üõí {{ user.purchase_count|default:0 }} –ø–æ–∫—É–ø–æ–∫</div>
                            <div>üìä {{ user.subscription_count|default:0 }} –ø–æ–¥–ø–∏—Å–æ–∫</div>
                        </div>
                    </td>
                    <td>
                        {{ user.created_at|date:"d.m.Y" }}
                        <div style="font-size: 11px; color: #718096;">
                            {{ user.created_at|date:"H:i" }}
                        </div>
                    </td>
                    <td class="actions">
                        <a href="{% url 'admin_user_activity' user.id %}" class="btn" style="padding: 4px 8px; font-size: 12px;">üìä –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</a>
                        <a href="{% url 'admin_user_edit' user.id %}" class="btn" style="padding: 4px 8px; font-size: 12px; background: #4299e1;">‚úèÔ∏è</a>
                        
                        {% if user.is_active %}
                        <form method="post" action="{% url 'admin_user_toggle_status' user.id %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="deactivate">
                            <button type="submit" class="btn" style="background: #ed8936; padding: 4px 8px; font-size: 12px;"
                                    onclick="return confirm('–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.login }}?')">
                                ‚è∏Ô∏è
                            </button>
                        </form>
                        {% else %}
                        <form method="post" action="{% url 'admin_user_toggle_status' user.id %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="activate">
                            <button type="submit" class="btn" style="background: #48bb78; padding: 4px 8px; font-size: 12px;">
                                ‚ñ∂Ô∏è
                            </button>
                        </form>
                        {% endif %}
                        
                        <form method="post" action="{% url 'admin_user_delete' user.id %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_force">
                            <button type="submit" class="btn btn-danger" 
                                    style="padding: 4px 8px; font-size: 12px;"
                                    onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.login }} ({{ user.email }})?')">
                                üóëÔ∏è
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if search_query or status_filter != 'all' or date_from or date_to %}
    <div style="margin-top: 20px; padding: 10px; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 4px;">
        –ù–∞–π–¥–µ–Ω–æ {{ users|length }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        {% if search_query %}–ø–æ –∑–∞–ø—Ä–æ—Å—É: "<strong>{{ search_query }}</strong>"{% endif %}
        {% if status_filter != 'all' %}—Å—Ç–∞—Ç—É—Å: <strong>{{ status_filter }}</strong>{% endif %}
        {% if date_from %}—Å {{ date_from }}{% endif %}
        {% if date_to %}–ø–æ {{ date_to }}{% endif %}
    </div>
    {% endif %}
    
    {% else %}
    <div style="text-align: center; padding: 40px; color: #718096;">
        {% if search_query or status_filter != 'all' or date_from or date_to %}
        <p>–ü–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
        <a href="{% url 'admin_users_list' %}" class="btn" style="margin-top: 15px;">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</a>
        {% else %}
        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        <a href="{% url 'admin_user_create' %}" class="btn btn-success" style="margin-top: 15px;">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    document.getElementById('statusFilter').value = urlParams.get('status') || 'all';
    document.getElementById('dateFrom').value = urlParams.get('date_from') || '';
    document.getElementById('dateTo').value = urlParams.get('date_to') || '';

    const searchInput = document.querySelector('input[name="search"]');
    searchInput.value = urlParams.get('search') || '';
});

function submitForm() {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    
    const searchValue = document.querySelector('input[name="search"]').value;
    const statusValue = document.getElementById('statusFilter').value;
    const dateFromValue = document.getElementById('dateFrom').value;
    const dateToValue = document.getElementById('dateTo').value;
    
    const params = new URLSearchParams();
    
    if (searchValue) params.set('search', searchValue);
    if (statusValue && statusValue !== 'all') params.set('status', statusValue);
    if (dateFromValue) params.set('date_from', dateFromValue);
    if (dateToValue) params.set('date_to', dateToValue);
    
    window.location.href = '{% url "admin_users_list" %}' + (params.toString() ? '?' + params.toString() : '');
}

function clearFilters() {
    window.location.href = '{% url "admin_users_list" %}';
}
</script>

{% endblock %}