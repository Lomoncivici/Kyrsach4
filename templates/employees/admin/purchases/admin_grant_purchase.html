{% extends 'employees/admin/admin_base.html' %}

{% block title %}–í—ã–¥–∞—Ç—å –ø–æ–∫—É–ø–∫—É - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º{% endblock %}
{% block page_title %}üéÅ –í—ã–¥–∞—Ç—å –ø–æ–∫—É–ø–∫—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞{% endblock %}

{% block admin_nav %}
{{ block.super }}
<a href="{% url 'admin_user_purchases' %}" 
   {% if request.resolver_match.url_name == 'admin_user_purchases' %}class="active"{% endif %}>
   üõí –ü–æ–∫—É–ø–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
</a>
{% endblock %}

{% block content %}
<div class="content-box">
    <h2>–í—ã–¥–∞—á–∞ –ø–æ–∫—É–ø–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h2>
    
    <form method="post" style="max-width: 800px;">
        {% csrf_token %}
        
        <div class="form-row">
            <div class="form-group">
                <label for="user_id">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</label>
                <select id="user_id" name="user_id" required style="width: 100%; padding: 10px;">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>
                    {% for user in users %}
                    <option value="{{ user.0 }}">{{ user.1 }} ({{ user.2 }})</option>
                    {% endfor %}
                </select>
                <div style="font-size: 12px; color: #718096;">
                    –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                </div>
            </div>
            
            <div class="form-group">
                <label for="content_id">–ö–æ–Ω—Ç–µ–Ω—Ç *</label>
                <select id="content_id" name="content_id" required style="width: 100%; padding: 10px;"
                        onchange="updateContentInfo()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç...</option>
                    {% for content in content_list %}
                    <option value="{{ content.0 }}" 
                            data-price="{{ content.3 }}"
                            data-type="{{ content.2 }}"
                            data-year="{{ content.4 }}">
                        {{ content.1 }} ({{ content.2 }}) - {{ content.3 }} ‚ÇΩ
                    </option>
                    {% endfor %}
                </select>
                <div style="font-size: 12px; color: #718096;">
                    –¢–æ–ª—å–∫–æ –ø–ª–∞—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Ü–µ–Ω–∞ > 0)
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="purchase_date">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</label>
                <input type="datetime-local" id="purchase_date" name="purchase_date" 
                       value="{{ now }}">
                <div style="font-size: 12px; color: #718096;">
                    –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-group">
                <input type="checkbox" id="create_payment" name="create_payment" checked>
                <span>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –æ–± –æ–ø–ª–∞—Ç–µ</span>
            </label>
            <div style="font-size: 12px; color: #718096; margin-left: 25px;">
                –°–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ payments —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "paid"
            </div>
        </div>
        
        <div class="form-group">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ</h3>
            <div style="background: #f0f4f8; padding: 15px; border-radius: 8px; margin-top: 10px;">
                <div id="content_info" style="color: #718096;">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-success">üéÅ –í—ã–¥–∞—Ç—å –ø–æ–∫—É–ø–∫—É</button>
            <a href="{% url 'admin_user_purchases' %}" class="btn" style="background: #a0aec0; margin-left: 10px;">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentSelect = document.getElementById('content_id');
    const contentInfo = document.getElementById('content_info');
    const userSelect = document.getElementById('user_id');
    const purchaseDateInput = document.getElementById('purchase_date');
    const createPaymentCheckbox = document.getElementById('create_payment');

    if (!purchaseDateInput.value) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        purchaseDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    function updateContentInfo() {
        const selectedContent = contentSelect.options[contentSelect.selectedIndex];
        const price = selectedContent.dataset.price || '0.00';
        const type = selectedContent.dataset.type || '';
        const year = selectedContent.dataset.year || '';
        
        if (contentSelect.value) {
            contentInfo.innerHTML = `
                <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${selectedContent.text}<br>
                <strong>–¢–∏–ø:</strong> ${type}<br>
                <strong>–ì–æ–¥:</strong> ${year}<br>
                <strong>–¶–µ–Ω–∞:</strong> ${price} ‚ÇΩ<br>
                <strong>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏:</strong> ${purchaseDateInput.value || '—Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞'}<br>
                <strong>–û–ø–ª–∞—Ç–∞:</strong> ${createPaymentCheckbox.checked ? '—Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å' : '–±–µ–∑ –∑–∞–ø–∏—Å–∏'}
            `;
        } else {
            contentInfo.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏';
        }
    }

    contentSelect.addEventListener('change', updateContentInfo);
    purchaseDateInput.addEventListener('change', updateContentInfo);
    createPaymentCheckbox.addEventListener('change', updateContentInfo);
    
    updateContentInfo();
    
    userSelect.focus();
});

document.querySelector('form').addEventListener('submit', function(e) {
    const userSelect = document.getElementById('user_id');
    const contentSelect = document.getElementById('content_id');
    
    if (!userSelect.value) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        e.preventDefault();
        return false;
    }
    
    if (!contentSelect.value) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç');
        e.preventDefault();
        return false;
    }
    
    return true;
});
</script>
{% endblock %}