{% extends 'employees/base.html' %}
{% load static %}

{% block title %}üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - –ö–∏–Ω–æ–í–µ—á–µ—Ä{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìà –ü–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∞/—Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç–∞</h1>
    <p>–ü–µ—Ä–∏–æ–¥: {{ start_date }} ‚Äì {{ end_date }}</p>
</div>

<div class="period-selector">
    <h3 style="margin-top: 0;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:</h3>
    <div class="period-buttons">
        <a href="?period=7d" class="period-btn {% if period == '7d' %}active{% endif %}">7 –¥–Ω–µ–π</a>
        <a href="?period=30d" class="period-btn {% if period == '30d' %}active{% endif %}">30 –¥–Ω–µ–π</a>
        <a href="?period=90d" class="period-btn {% if period == '90d' %}active{% endif %}">90 –¥–Ω–µ–π</a>
        <a href="?period=all" class="period-btn {% if period == 'all' %}active{% endif %}">–í—Å–µ –≤—Ä–µ–º—è</a>
        
        <form method="GET" style="display: flex; gap: 10px; align-items: center;">
            <input type="date" name="start_date" value="{{ start_date_str }}" 
                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <span>–ø–æ</span>
            <input type="date" name="end_date" value="{{ end_date_str }}"
                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <input type="hidden" name="period" value="custom">
            <button type="submit" 
                    style="padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
        </form>
    </div>
    
    <div class="export-buttons">
        <a href="{% url 'export_analytics' %}?format=csv&period={{ period }}&start_date={{ start_date_str }}&end_date={{ end_date_str }}" 
           class="btn-excel">
            üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
        </a>
        <a href="{% url 'export_analytics' %}?format=html&period={{ period }}&start_date={{ start_date_str }}&end_date={{ end_date_str }}" 
           class="btn-html">
            üìà –≠–∫—Å–ø–æ—Ä—Ç –≤ HTML
        </a>
    </div>
</div>

<div class="dashboard-container">
    <div class="stat-card">
        <h3>üí∞ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</h3>
        <div class="stat-value">{{ total_revenue|floatformat:2 }} ‚ÇΩ</div>
        <div class="stat-label">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
        {% if paid_amount > 0 %}
        <div class="stat-trend trend-up">
            ‚ñ≤ {{ paid_amount|floatformat:2 }} ‚ÇΩ –æ–ø–ª–∞—á–µ–Ω–æ
        </div>
        {% endif %}
    </div>
    
    <div class="stat-card">
        <h3>üë• –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        <div class="stat-value">{{ registrations|length }}</div>
        <div class="stat-label">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π</div>
        {% if conversion_stats %}
        <div class="stat-trend trend-info">
            –ö–æ–Ω–≤–µ—Ä—Å–∏—è: {{ conversion_stats.3|default:0|floatformat:1 }}%
        </div>
        {% endif %}
    </div>
    
    <div class="stat-card">
        <h3>üõí –ü–æ–∫—É–ø–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h3>
        {% with total_purchases=purchases|length %}
        <div class="stat-value">{{ total_purchases }}</div>
        <div class="stat-label">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
        {% endwith %}
        {% if purchases %}
        {% with last_day=purchases|last %}
        {% if last_day.1 > 0 %}
        <div class="stat-trend trend-up">
            ‚ñ≤ {{ last_day.1 }} –ø–æ–∫—É–ø–æ–∫ –≤—á–µ—Ä–∞
        </div>
        {% endif %}
        {% endwith %}
        {% endif %}
    </div>
    
    <div class="stat-card">
        <h3>üìä ARPU</h3>
        {% if arpu_stats %}
        <div class="stat-value">{{ arpu_stats.2|default:0|floatformat:2 }} ‚ÇΩ</div>
        <div class="stat-label">–î–æ—Ö–æ–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
        <div class="stat-trend">
            {{ arpu_stats.0 }} –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        </div>
        {% endif %}
    </div>
    
    <div class="stat-card">
        <h3>‚è±Ô∏è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
        {% if user_activity %}
        <div class="stat-value">{{ user_activity.0 }}</div>
        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        <div class="stat-trend">
            {{ user_activity.1 }} —Å–µ—Å—Å–∏–π
        </div>
        {% endif %}
    </div>
    
    <div class="stat-card">
        <h3>üìà –£–¥–µ—Ä–∂–∞–Ω–∏–µ</h3>
        {% if retention_stats %}
        <div class="stat-value">{{ retention_stats.0.2|default:0|floatformat:1 }}%</div>
        <div class="stat-label">Retention Week 0</div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ retention_stats.0.2|default:0 }}%"></div>
        </div>
        {% endif %}
    </div>
</div>

<div class="chart-grid">
    <div class="chart-container">
        <h3 class="chart-title">üìà –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
        <div class="chart-wrapper">
            <canvas id="registrationsChart"></canvas>
        </div>
    </div>
    
    <div class="chart-container">
        <h3 class="chart-title">üí∞ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≤—ã—Ä—É—á–∫–∞</h3>
        <div class="chart-wrapper">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
    
    <div class="chart-container">
        <h3 class="chart-title">üõí –ü–æ–∫—É–ø–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h3>
        <div class="chart-wrapper">
            <canvas id="purchasesChart"></canvas>
        </div>
    </div>
</div>

<div class="chart-container">
    <h3 class="chart-title">üìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂ –ø–æ–¥–ø–∏—Å–æ–∫</h3>
    {% if subscription_types_data %}
    <table class="data-table">
        <thead>
            <tr>
                <th>–¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏</th>
                <th>–ü–µ—Ä–∏–æ–¥</th>
                <th>–¶–µ–Ω–∞ (‚ÇΩ)</th>
                <th>–í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫</th>
                <th>–û–ø–ª–∞—á–µ–Ω–æ</th>
                <th>–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)</th>
                <th>–°—Ä. —á–µ–∫ (‚ÇΩ)</th>
                <th>–î–æ–ª—è –≤ –≤—ã—Ä—É—á–∫–µ</th>
            </tr>
        </thead>
        <tbody>
            {% for sub in subscription_types_data %}
            {% with revenue=sub.revenue|default:0 %}
            {% if total_subscriptions_revenue_all > 0 %}
                {% widthratio revenue total_subscriptions_revenue_all 100 as revenue_share %}
            {% else %}
                {% with revenue_share=0 %}{% endwith %}
            {% endif %}
            <tr>
                <td><strong>{{ sub.name }}</strong></td>
                <td>{{ sub.period }}</td>
                <td>{{ sub.price|floatformat:2 }}</td>
                <td>{{ sub.total_subscriptions }}</td>
                <td>{{ sub.paid_subscriptions }}</td>
                <td>
                    <strong>{{ revenue|floatformat:2 }}</strong>
                    {% if revenue > 0 %}
                        <div class="progress-bar" style="margin-top: 5px;">
                            <div class="progress-fill" style="width: {{ revenue_share }}%"></div>
                        </div>
                    {% endif %}
                </td>
                <td>{{ sub.avg_revenue|floatformat:2 }}</td>
                <td>
                    {{ revenue_share|floatformat:1 }}%
                </td>
            </tr>
            {% endwith %}
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="background: #f8fafc; font-weight: 600;">
                <td colspan="3"><strong>–ò–¢–û–ì–û:</strong></td>
                <td>{{ total_subscriptions_sold }}</td>
                <td>{{ total_paid_subscriptions }}</td>
                <td><strong>{{ total_subscriptions_revenue_all|floatformat:2 }} ‚ÇΩ</strong></td>
                <td>
                    {% if total_paid_subscriptions > 0 %}
                        {{ total_subscriptions_revenue_all|divisibleby:total_paid_subscriptions|default:total_subscriptions_revenue_all|floatformat:2 }} ‚ÇΩ
                    {% else %}
                        0 ‚ÇΩ
                    {% endif %}
                </td>
                <td>100%</td>
            </tr>
        </tfoot>
    </table>
    {% else %}
    <p style="color: #888; text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥–∞–∂–∞—Ö –ø–æ–¥–ø–∏—Å–æ–∫</p>
    {% endif %}
</div>

<div class="chart-container">
    <h3 class="chart-title">üé¨ –°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</h3>
    {% if popular_content %}
    <table class="data-table">
        <thead>
            <tr>
                <th>–ö–æ–Ω—Ç–µ–Ω—Ç</th>
                <th>–¢–∏–ø</th>
                <th>–ü–æ–∫—É–ø–æ–∫</th>
                <th>–í—ã—Ä—É—á–∫–∞</th>
                <th>–†–µ–π—Ç–∏–Ω–≥</th>
            </tr>
        </thead>
        <tbody>
            {% for item in popular_content %}
            <tr>
                <td>{{ item.0|truncatechars:40 }}</td>
                <td>
                    <span class="metric-badge {% if item.1 == 'movie' %}badge-info{% else %}badge-warning{% endif %}">
                        {{ item.1 }}
                    </span>
                </td>
                <td>{{ item.2 }}</td>
                <td>{{ item.3|floatformat:2 }} ‚ÇΩ</td>
                <td>
                    <span class="metric-badge {% if item.4 >= 4 %}badge-success{% elif item.4 >= 3 %}badge-warning{% else %}badge-danger{% endif %}">
                        {{ item.4|floatformat:1 }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #888; text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ø—É–ª—è—Ä–Ω–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ</p>
    {% endif %}
</div>

<div class="chart-container">
    <h3 class="chart-title">üí≥ –î–µ—Ç–∞–ª—å–Ω–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    {% if financial_stats %}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div class="stat-card">
            <div class="stat-label">–û–±—â–µ–µ –∫–æ–ª-–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π</div>
            <div class="stat-value">{{ financial_stats.0 }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">–£—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</div>
            <div class="stat-value">{{ financial_stats.5 }}</div>
            <div class="stat-trend trend-up">
                {{ financial_stats.2|floatformat:2 }} ‚ÇΩ
            </div>
            <div class="stat-desc">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {{ financial_stats.8|floatformat:2 }} ‚ÇΩ</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">–ù–µ—É–¥–∞—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</div>
            <div class="stat-value">{{ financial_stats.6 }}</div>
            <div class="stat-trend trend-down">
                {{ financial_stats.3|floatformat:2 }} ‚ÇΩ
            </div>
            <div class="stat-desc">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {{ financial_stats.9|floatformat:2 }} ‚ÇΩ</div>
        </div>
    </div>
    {% endif %}

    {% if financial_stats and financial_stats.2 > 0 %}
    <div class="insight-card">
        <p class="insight-text">
            üí° <strong>–ê–Ω–∞–ª–∏–∑ –ø–ª–∞—Ç–µ–∂–µ–π:</strong>
            –ö–æ–Ω–≤–µ—Ä—Å–∏—è —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π: 
            {% with total=financial_stats.0 paid=financial_stats.5 %}
                {% if total > 0 %}
                    {% widthratio paid total 100 as conversion %}
                    <strong>{{ conversion }}%</strong>
                {% else %}
                    <strong>0%</strong>
                {% endif %}
            {% endwith %}
            <br>
            –£—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç <strong>{{ financial_stats.2|floatformat:2 }} ‚ÇΩ</strong> 
            –∏–∑ –æ–±—â–µ–π —Å—É–º–º—ã <strong>{{ financial_stats.1|floatformat:2 }} ‚ÇΩ</strong>
            ({% widthratio financial_stats.2 financial_stats.1 100 %}%).
        </p>
    </div>
    {% endif %}
    
    {% if total_revenue > 0 %}
    <div class="insight-card">
        <p class="insight-text">
            üí° <strong>–ò–Ω—Å–∞–π—Ç:</strong> –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 
            <strong>{{ total_revenue|floatformat:2 }} ‚ÇΩ</strong>.
            {% if arpu_stats and arpu_stats.2 > 0 %}
            –ö–∞–∂–¥—ã–π –ø–ª–∞—Ç—è—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω–æ—Å–∏—Ç –≤ —Å—Ä–µ–¥–Ω–µ–º {{ arpu_stats.2|floatformat:2 }} ‚ÇΩ.
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>

{% if genre_stats %}
<div class="chart-container">
    <h3 class="chart-title">üé≠ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∂–∞–Ω—Ä–∞–º</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>–ñ–∞–Ω—Ä</th>
                <th>–ö–æ–Ω—Ç–µ–Ω—Ç–∞</th>
                <th>–ü–æ–∫—É–ø–æ–∫</th>
                <th>–í—ã—Ä—É—á–∫–∞</th>
                <th>–î–æ–ª—è</th>
            </tr>
        </thead>
        <tbody>
            {% for genre in genre_stats %}
            {% with revenue=genre.3|default:0 %}
            <tr>
                <td>{{ genre.0 }}</td>
                <td>{{ genre.1 }}</td>
                <td>{{ genre.2 }}</td>
                <td>{{ revenue|floatformat:2 }} ‚ÇΩ</td>
                <td>
                    <div class="progress-bar">
                        {% if total_revenue > 0 %}
                            {% with percentage=revenue|floatformat:2|add:"0" %}
                                {% widthratio revenue total_revenue 100 as percentage_int %}
                                <div class="progress-fill" style="width: {{ percentage_int }}%"></div>
                                <span style="font-size: 12px; margin-left: 5px;">{{ percentage_int }}%</span>
                            {% endwith %}
                        {% else %}
                            <div class="progress-fill" style="width: 0%"></div>
                            <span style="font-size: 12px; margin-left: 5px;">0%</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endwith %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if retention_stats %}
<div class="chart-container">
    <h3 class="chart-title">üìä –£–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (Retention)</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>–ö–æ–≥–æ—Ä—Ç–∞</th>
                <th>–†–∞–∑–º–µ—Ä</th>
                <th>Week 0</th>
                <th>Week 1</th>
                <th>Week 2</th>
                <th>Week 3</th>
            </tr>
        </thead>
        <tbody>
            {% for cohort in retention_stats %}
            <tr>
                <td>{{ cohort.0 }}</td>
                <td>{{ cohort.1 }}</td>
                <td>{{ cohort.2|floatformat:1 }}%</td>
                <td>{{ cohort.3|floatformat:1 }}%</td>
                <td>{{ cohort.4|floatformat:1 }}%</td>
                <td>{{ cohort.5|floatformat:1 }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/analytics.js' %}"></script>

<script id="analytics-data" type="application/json">
{
    "registrations": {{ chart_data_json|safe }}.registrations || [],
    "daily_revenue": {{ chart_data_json|safe }}.daily_revenue || [],
    "purchases": {{ chart_data_json|safe }}.purchases || [],
    "subscriptions": [
        {% if subscription_stats %}
            {% for sub in subscription_stats %}
                {
                    "plan": "{{ sub.0|escapejs }}",
                    "total": {{ sub.1|default:0 }},
                    "active": {{ sub.2|default:0 }},
                    "not_expired": {{ sub.3|default:0 }},
                    "expired": {{ sub.4|default:0 }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        {% else %}
            []
        {% endif %}
    ]
}
</script>

<div class="subscriptions-data" style="display: none;">
{
    "labels": [
        {% for sub in subscription_stats|slice:":5" %}
        "{{ sub.0|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    "data": [
        {% for sub in subscription_stats|slice:":5" %}
        {{ sub.1|default:0 }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
}
</div>

<script>
window.analyticsChartData = {
    registrations: {{ chart_data_json|safe }}.registrations || [],
    daily_revenue: {{ chart_data_json|safe }}.daily_revenue || [],
    purchases: {{ chart_data_json|safe }}.purchases || [],
    subscriptions: {{ chart_data_json|safe }}.subscriptions || []
};
</script>
{% endblock %}