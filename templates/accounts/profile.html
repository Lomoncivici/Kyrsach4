{% extends 'base.html' %}
{% block title %}Мой аккаунт — Онлайн-кинотеатр{% endblock %}
{% block content %}
<section class="profile">
  <h1>Профиль</h1>

  {% if messages %}
    <div class="messages">
      {% for m in messages %}
        <div class="alert {% if m.tags %}alert-{{ m.tags }}{% endif %}">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="grid">
    <div class="panel">
      <h2>Учётные данные</h2>

      <form method="post" action="">
        {% csrf_token %}

        <div class="field {% if field_errors.username %}has-error{% endif %}">
          <label>Логин</label>
          <input type="text"
                 name="username"
                 value="{{ form_username|default:user.username }}"
                 required
                 pattern="[A-Za-z0-9._-]{5,32}"
                 title="5–32 символов: латиница, цифры, . _ -">
          {% if field_errors.username %}<div class="error">{{ field_errors.username }}</div>{% endif %}
        </div>

        <div class="field {% if field_errors.email %}has-error{% endif %}">
          <label>Почта</label>
          <input type="email"
                 name="email"
                 value="{{ form_email|default:user.email }}"
                 required>
          {% if field_errors.email %}<div class="error">{{ field_errors.email }}</div>{% endif %}
        </div>

        <div class="field {% if field_errors.phone %}has-error{% endif %}">
          <label>Телефон</label>
          <input type="text"
                 name="phone"
                 value="{{ form_phone|default:user.profile.phone }}"
                 pattern="^\+?\d{10,15}$"
                 title="+79991234567 (10–15 цифр)">
          {% if field_errors.phone %}<div class="error">{{ field_errors.phone }}</div>{% endif %}
        </div>

        <button class="btn btn-primary" type="submit">Сохранить</button>
      </form>
    </div>

    <div class="panel">
      <h2>Подписка</h2>
      {% if subscription %}
        <p>План: <b>{{ subscription.plan_name }}</b></p>
        <p>Активна до: <b>{{ subscription.active_until }}</b></p>
      {% else %}
        <p>Нет активной подписки.</p>
        <a class="btn" href="/subscriptions">Оформить</a>
      {% endif %}
    </div>

    <div class="panel">
      <h2>Покупки</h2>
      <ul class="list">
        {% for p in purchases %}
          <li><a href="{% url 'content_detail' p.content_id %}">{{ p.title }}</a> — {{ p.date }}</li>
        {% empty %}
          <li>Пока пусто</li>
        {% endfor %}
      </ul>
    </div>

    <div class="panel">
      <h2>Мои оценки</h2>
      <ul class="list">
        {% for r in ratings %}
          <li><a href="{% url 'content_detail' r.content_id %}">{{ r.title }}</a> — ★ {{ r.rating }}</li>
        {% empty %}
          <li>Ещё нет оценок</li>
        {% endfor %}
      </ul>
    </div>

    <div class="panel">
      <h2>История просмотров</h2>
      <ul class="list">
        {% for h in history %}
          <li><a href="{% url 'content_detail' h.content_id %}">{{ h.title }}</a> — {{ h.progress_percent }}%</li>
        {% empty %}
          <li>История пуста</li>
        {% endfor %}
      </ul>
    </div>

    <div class="panel">
      <h2>Поддержка</h2>
      <p class="muted">Нужна помощь? Напишите в поддержку.</p>
      <button class="btn btn-primary" id="openSupport">Открыть чат</button>
    </div>
  </div>
</section>

<div id="supportModal" class="modal">
  <div class="modal__inner">
    <header class="modal__header">
      <h3>Чат поддержки</h3>
      <button class="icon-btn" data-close>✕</button>
    </header>
    <div class="chat" id="chatBox"></div>
    <form class="chat__input" method="post" action="/support/send">
      {% csrf_token %}
      <input name="text" placeholder="Ваш вопрос…" required>
      <button class="btn btn-primary" type="submit">Отправить</button>
    </form>
  </div>
</div>
{% endblock %}